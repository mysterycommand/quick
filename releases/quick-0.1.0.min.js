/**
 * Copyright (c) 2014, 2015 Diogo Schneider
 * 
 * Released under The MIT License (MIT)
 * 
 * https://github.com/dgsprb/quick
 */

(function(){var c={UP:0,DOWN:1,LEFT:2,RIGHT:3,A:4,B:5,X:6,Y:7,SELECT:8,START:9},k=function(){function b(){function n(){b()}for(var e=0;e<k.length;++e)if(!k[e].complete){setTimeout(n,100);return}r=new d;a()}function a(){function b(){requestAnimationFrame(a)}if(l){var n=Date.now(),d=f.getContext("2d");g=!g;z.update();null!=x?x.sync()&&(x=null):(m&&(m=!1,r=r.getNext()),r.sync()?(m=!0,x=r.getTransition()):r.update());q.update();for(var e=0;e<y.length;++e)y[e].render(d);n=Date.now()-n;setTimeout(b,h-n)}}
function n(){function a(b){b()}window.requestAnimationFrame||(window.requestAnimationFrame=a)}function e(){c&&(f.style.width=window.innerWidth+"px",f.style.height=window.innerHeight+"px")}var d,c=!0,f,g=!0,h,k,z,l,m=!1,u="Game",v=1,y=[],r,q,x,A=0,B=0;return{init:function(a,c){f=a;A=f.width;B=f.height;d=c;k=document.getElementsByTagName("img");z=new t;l=!0;q=new E;addEventListener("resize",e,!1);e();n();this.setFrameTime();for(var p=0;p<v;++p)y.push(new F);b()},clearCanvas:function(){f.height=f.height},
fadeOut:function(){q.fadeOut()},getCanvasBottom:function(){return B-1},getCanvasCenter:function(){return new w(this.getCanvasCenterX(),this.getCanvasCenterY())},getCanvasCenterX:function(){return Math.floor(this.getCanvasWidth()/2)},getCanvasCenterY:function(){return Math.floor(this.getCanvasHeight()/2)},getCanvasHeight:function(){return B},getCanvasRight:function(){return A-1},getCanvasWidth:function(){return A},getController:function(a){return z.getController(a)},getEveryOther:function(){return g},
getFrameTime:function(){return h},mute:function(){q.mute()},paint:function(a,b){y[b||0].add(a)},play:function(a){q.play(a)},playTheme:function(a){q.playTheme(a)},random:function(a){a=Math.random()*(a+1);return Math.floor(a)},setAutoScale:function(a){c=void 0==a||a},setFrameTime:function(a){h=a||30},setName:function(a){u=a;document.title=u},setNumberOfLayers:function(a){v=a},stopTheme:function(){q.stopTheme()}}}(),G=function(){function b(a,b,e){var d=document.createElement("canvas");d.width=a.width;
d.height=a.height;var c=d.getContext("2d");c.translate(b?d.width:0,e?d.height:0);c.scale(b?-1:1,e?-1:1);c.drawImage(a,0,0);return d}return{flip:function(a){return b(a,!1,!0)},mirror:function(a){return b(a,!0,!1)},rotate:function(a,b){if(0==b%360)return a;var e=b*Math.PI/180,d=document.createElement("canvas");90==b||270==b?(d.width=a.height,d.height=a.width):(d.width=a.width,d.height=a.height);var c=d.getContext("2d");c.translate(d.width/2,d.height/2);c.rotate(e);c.drawImage(a,-a.width/2,-a.height/
2);return d}}}(),H=function(){function b(){this.active={};this.device=null;this.held={}}b.prototype.keyDown=function(a){return this.active[a]};b.prototype.keyPush=function(a){return this.active[a]&&!this.held[a]};b.prototype.setDevice=function(a){this.device=a};b.prototype.update=function(){if(this.device){this.held={};var a=this.active;this.active=this.device.getCommands();for(var b in this.active)a[b]&&(this.held[b]=!0)}};return b}(),I=function(){function b(a){this.id=a||0}var a={};a[12]=c.UP;a[13]=
c.DOWN;a[14]=c.LEFT;a[15]=c.RIGHT;a[0]=c.A;a[1]=c.B;a[2]=c.X;a[3]=c.Y;a[9]=c.START;a[8]=c.SELECT;b.prototype.getCommands=function(){var b={};-.5>t.getGamepadAxes(this.id)[1]?b[c.UP]=!0:.5<t.getGamepadAxes(this.id)[1]&&(b[c.DOWN]=!0);-.5>t.getGamepadAxes(this.id)[0]?b[c.LEFT]=!0:.5<t.getGamepadAxes(this.id)[0]&&(b[c.RIGHT]=!0);for(var e in a)t.getGamepadButtons(this.id,e)&&(b[a[e]]=!0);return b};return b}(),t=function(){function b(){this.controllerQueue=[];this.controllers=[];this.deviceQueue=[];this.deviceRequestQueue=
[];this.gamepads=0;this.waitKeyboard();this.waitTouch()}b.getGamepads=function(){return navigator.getGamepads?navigator.getGamepads():[]};b.getGamepadAxes=function(a){return b.getGamepads()[a]?b.getGamepads()[a].axes:[]};b.getGamepadButtons=function(a,n){return b.getGamepads()[a]?b.getGamepads()[a].buttons[n].pressed:!1};b.prototype.addDevice=function(a){this.deviceQueue.push(a);this.checkQueues()};b.prototype.checkGamepads=function(){b.getGamepads()[this.gamepads]&&this.addDevice(new I(this.gamepads++))};
b.prototype.checkQueues=function(){if(0<this.deviceRequestQueue.length&&0<this.deviceQueue.length){var a=this.deviceRequestQueue.shift(),b=this.deviceQueue.shift();a.setDevice(b)}};b.prototype.getController=function(a){a=a||0;if(this.controllers.length<a+1){var b=new H;this.controllers.push(b);this.deviceRequestQueue.push(b);this.checkQueues()}return this.controllers[a]};b.prototype.update=function(){this.checkGamepads();for(var a in this.controllers)this.controllers[a].update()};b.prototype.waitKeyboard=
function(){function a(e){removeEventListener("keydown",a,!1);b.addDevice(new J(e))}var b=this;addEventListener("keydown",a,!1)};b.prototype.waitTouch=function(){function a(e){removeEventListener("touchstart",a,!1);b.addDevice(new K(e))}var b=this;addEventListener("touchstart",a,!1)};return b}(),J=function(){function b(b){function e(b){b.preventDefault();d.buffer[a[b.keyCode]]=!0}var d=this;this.buffer={};addEventListener("keydown",e,!1);addEventListener("keyup",function(b){d.buffer[a[b.keyCode]]=
!1},!1);e(b)}var a={};a[38]=c.UP;a[69]=c.UP;a[73]=c.UP;a[40]=c.DOWN;a[68]=c.DOWN;a[75]=c.DOWN;a[37]=c.LEFT;a[83]=c.LEFT;a[74]=c.LEFT;a[39]=c.RIGHT;a[70]=c.RIGHT;a[76]=c.RIGHT;a[32]=c.A;a[18]=c.B;a[17]=c.X;a[16]=c.Y;a[13]=c.START;a[127]=c.SELECT;b.prototype.getCommands=function(){var a={},b;for(b in this.buffer)this.buffer[b]&&(a[b]=!0);return a};return b}(),F=function(){function b(){this.elements=[]}b.prototype.add=function(a){this.elements.push(a)};b.prototype.render=function(a){for(var b=0;b<this.elements.length;++b)this.elements[b].render(a);
this.elements.length=0};return b}(),L=function(){function b(){this.gameObjects=[];this.nextObjects=[];this.expiration=-1;this.isExpired=!1;this.tick=-1;this.transition=null}b.prototype.add=function(a){a.setScene(this);this.nextObjects.push(a);a.move(-1*a.getSpeedX(),-1*a.getSpeedY())};b.prototype.build=function(a,b){b=b||C;for(var e=0;e<a.length;++e)for(var d=a[e],c=0;c<d.length;++c){var f=a[e][c];f&&(f=new b(f),f.setTop(e*f.getHeight()),f.setLeft(c*f.getWidth()),this.add(f))}};b.prototype.expire=
function(){this.isExpired=!0};b.prototype.sync=function(){if(this.isExpired)return!0;for(var a=[],b=[],c=0;c<this.gameObjects.length;++c){var d=this.gameObjects[c];d.update();d.sync()?d.getEssential()&&this.expire():(d.getSolid()&&b.push(d),a.push(d),k.paint(d,d.getLayerIndex()))}c=b.length;for(d=0;d<c-1;++d)for(var p=b[d],f=d+1;f<c;++f){var g=b[f];p.hasCollision(g)&&(p.onCollision(g),g.onCollision(p))}this.gameObjects=a.concat(this.nextObjects);this.nextObjects=[];++this.tick==this.expiration&&this.expire();
return!1};b.prototype.getNext=function(){return null};b.prototype.getTick=function(){return this.tick};b.prototype.getTransition=function(){return this.transition};b.prototype.setExpiration=function(a){this.expiration=a};b.prototype.setTransition=function(a){this.transition=a};b.prototype.update=function(){};return b}(),E=function(){function b(){this.isMute=this.isFading=!1;this.nextThemeName=null;this.queue={};this.theme=null;this.volume=100}b.prototype.fadeOut=function(){this.theme&&(this.isFading=
!0,this.volume=100)};b.prototype.mute=function(){(this.isMute=!this.isMute)?this.theme.pause():this.theme.play()};b.prototype.pause=function(){this.theme&&this.theme.pause()};b.prototype.play=function(a){this.isMute||(this.queue[a]=!0)};b.prototype.playTheme=function(a){this.theme&&0<this.theme.currentTime?(this.nextThemeName=a,this.isFading||this.fadeOut()):(this.stopTheme(),this.theme=document.getElementById(a),0<this.theme.currentTime&&(this.theme.currentTime=0),this.isMute||(this.theme.volume=
1,this.theme.play()))};b.prototype.resume=function(){this.isMute||this.theme.paused&&this.theme.play()};b.prototype.stopTheme=function(){this.theme&&(this.theme.pause(),this.theme.currentTime=0)};b.prototype.update=function(){for(var a in this.queue){var b=document.getElementById(a);b.pause();0<b.currentTime&&(b.currentTime=0);b.volume=.3;b.play()}this.queue={};this.isFading&&(0<--this.volume?this.theme.volume=this.volume/100:(this.isFading=!1,this.theme=null,this.nextThemeName&&(this.playTheme(this.nextThemeName),
this.nextThemeName=null)))};return b}(),K=function(){function b(a){function b(a){a.preventDefault();e.buffer[c.A]=!0}var e=this;this.buffer={};addEventListener("touchend",function(a){a.preventDefault();e.buffer[c.A]=!1},!1);addEventListener("touchmove",function(a){a.preventDefault();e.buffer[c.LEFT]=!1},!1);addEventListener("touchstart",b,!1);b(a)}b.prototype.getCommands=function(){var a={},b;for(b in this.buffer)this.buffer[b]&&(a[b]=!0);return a};return b}(),w=function(){function b(a,b){this.setAccelerationX();
this.setAccelerationY();this.setSpeedX();this.setSpeedY();this.setX(a||0);this.setY(b||0)}b.prototype.bounceX=function(){this.setSpeedX(-1*this.getSpeedX());this.moveX(this.getSpeedX())};b.prototype.bounceY=function(){this.setSpeedY(-1*this.getSpeedY());this.moveY(this.getSpeedY())};b.prototype.getAccelerationX=function(){return this.accelerationX};b.prototype.getAccelerationY=function(){return this.accelerationY};b.prototype.getSpeedX=function(){return this.speedX};b.prototype.getSpeedY=function(){return this.speedY};
b.prototype.getX=function(){return this.x};b.prototype.getY=function(){return this.y};b.prototype.move=function(a,b){this.moveX(a);this.moveY(b)};b.prototype.moveX=function(a){this.setX(this.getX()+a)};b.prototype.moveY=function(a){this.setY(this.getY()+a)};b.prototype.setAccelerationX=function(a){this.accelerationX=a||0};b.prototype.setAccelerationY=function(a){this.accelerationY=a||0};b.prototype.setSpeedX=function(a){this.speedX=a||0};b.prototype.setSpeedY=function(a){this.speedY=a||0};b.prototype.setX=
function(a){this.x=a};b.prototype.setY=function(a){this.y=a};b.prototype.stop=function(){this.setSpeedX(0);this.setSpeedY(0)};b.prototype.sync=function(){this.setSpeedX(this.getSpeedX()+this.accelerationX);this.setSpeedY(this.getSpeedY()+this.accelerationY);this.move(this.getSpeedX(),this.getSpeedY());return!1};return b}(),l=function(){function b(a,b,c,d){w.call(this,a,b);this.setHeight(d||0);this.setWidth(c||0)}b.prototype=Object.create(w.prototype);b.prototype.bounceFrom=function(a){(0>this.getSpeedX()&&
a.getLeft()||0<this.getSpeedX()&&a.getRight())&&this.bounceX();(0>this.getSpeedY()&&a.getTop()||0<this.getSpeedY()&&a.getBottom())&&this.bounceY()};b.prototype.getBottom=function(){return this.getY()+this.getHeight()-1};b.prototype.getCenter=function(){return new w(this.getCenterX(),this.getCenterY())};b.prototype.getCenterX=function(){return this.getX()+this.getHalfWidth()};b.prototype.getCenterY=function(){return this.getY()+this.getHalfHeight()};b.prototype.getCollision=function(a){var b=new M,
c=this.getTop(),d=this.getRight(),p=this.getBottom(),f=this.getLeft(),g=this.getCenterX(),h=this.getCenterY(),k=a.getTop(),l=a.getRight(),m=a.getBottom();a=a.getLeft();g<=a&&d<l?b.setRight():g>=l&&f>a&&b.setLeft();h<=k&&p<m?b.setBottom():h>=m&&c>k&&b.setTop();return b};b.prototype.getHalfHeight=function(){return Math.floor(this.getHeight()/2)};b.prototype.getHalfWidth=function(){return Math.floor(this.getWidth()/2)};b.prototype.getHeight=function(){return this.height};b.prototype.getLeft=function(){return this.getX()};
b.prototype.getRight=function(){return this.getX()+this.getWidth()-1};b.prototype.getTop=function(){return this.getY()};b.prototype.getWidth=function(){return this.width};b.prototype.hasCollision=function(a){return this.getLeft()>a.getRight()||this.getRight()<a.getLeft()||this.getTop()>a.getBottom()||this.getBottom()<a.getTop()?!1:!0};b.prototype.increase=function(a,b){this.increaseWidth(a);this.increaseHeight(b)};b.prototype.increaseHeight=function(a){this.setHeight(this.getHeight()+a)};b.prototype.increaseWidth=
function(a){this.setWidth(this.getWidth()+a)};b.prototype.setBottom=function(a){this.setY(a-this.getHeight()+1)};b.prototype.setCenter=function(a){this.setCenterX(a.getX());this.setCenterY(a.getY())};b.prototype.setCenterX=function(a){this.setX(a-this.getHalfWidth())};b.prototype.setCenterY=function(a){this.setY(a-this.getHalfHeight())};b.prototype.setHeight=function(a){this.height=a};b.prototype.setLeft=function(a){this.setX(a)};b.prototype.setRight=function(a){this.setX(a-this.getWidth()+1)};b.prototype.setSize=
function(a,b){this.setWidth(a);1<arguments.length?this.setHeight(b):this.setHeight(a)};b.prototype.setTop=function(a){this.setY(a)};b.prototype.setWidth=function(a){this.width=a};return b}(),M=function(){function b(){this.isTop=this.isRight=this.isLeft=this.isBottom=!1}b.prototype.getBottom=function(){return this.isBottom};b.prototype.getLeft=function(){return this.isLeft};b.prototype.getRight=function(){return this.isRight};b.prototype.getTop=function(){return this.isTop};b.prototype.setBottom=function(a){this.isBottom=
a||!0};b.prototype.setLeft=function(a){this.isLeft=a||!0};b.prototype.setRight=function(a){this.isRight=a||!0};b.prototype.setTop=function(a){this.isTop=a||!0};return b}(),u=function(){function b(a,b){this.duration=b||0;this.image=a||new Image}b.prototype.getDuration=function(){return this.duration};b.prototype.getHeight=function(){return this.image.height};b.prototype.getImage=function(){return this.image};b.prototype.getWidth=function(){return this.image.width};return b}(),D=function(){function b(a){this.setFrames(a)}
b.prototype.getHeight=function(){return this.frame.getHeight()};b.prototype.getImage=function(){return this.frame.getImage()};b.prototype.getWidth=function(){return this.frame.getWidth()};b.prototype.setFrameIndex=function(a){return a<this.frames.length&&-1<a?(this.frameIndex=a,this.tick=0,this.frame=this.frames[a],!0):!1};b.prototype.setFrames=function(a){this.frames=a||[new u];this.setFrameIndex(0)};b.prototype.update=function(){var a=!1;if(this.frame.getDuration()&&++this.tick>this.frame.getDuration()){var b=
this.frameIndex+1;b==this.frames.length&&(a=!0,b=0);this.setFrameIndex(b)}return a};return b}(),v=function(){function b(){l.call(this);this.delegate=this.animation=null}b.prototype=Object.create(l.prototype);b.prototype.getImage=function(){return this.animation.getImage()};b.prototype.onAnimationLoop=function(){this.delegate&&this.delegate.onAnimationLoop&&this.delegate.onAnimationLoop()};b.prototype.render=function(a){if(this.animation){var b=this.getImage(),c=Math.floor(this.getX()),d=Math.floor(this.getY());
a.drawImage(b,c,d,this.getWidth(),this.getHeight())}};b.prototype.setAnimation=function(a){this.animation!=a&&(this.animation=a,this.animation.setFrameIndex(0),this.setHeight(this.animation.getHeight()),this.setWidth(this.animation.getWidth()))};b.prototype.setDelegate=function(a){this.delegate=a};b.prototype.setImage=function(a){this.setAnimation(new D([new u(a)]))};b.prototype.setImageId=function(a){this.setImage(document.getElementById(a))};b.prototype.sync=function(){if(this.animation&&this.animation.update())this.onAnimationLoop();
return l.prototype.sync.call(this)};return b}(),m=function(){function b(a){v.call(this,a);this.boundary=null}b.prototype=Object.create(v.prototype);b.prototype.setBoundary=function(a){this.boundary=a};b.prototype.offBoundary=function(){this.delegate&&this.delegate.offBoundary&&this.delegate.offBoundary()};b.prototype.sync=function(){var a=v.prototype.sync.call(this);this.boundary&&!this.hasCollision(this.boundary)&&this.offBoundary();return a};return b}(),h=function(){function b(){m.call(this);this.color=
null;this.layerIndex=0;this.isSolid=this.isExpired=this.isEssential=!1;this.isVisible=!0;this.scene=null;this.tags={};this.tick=0}b.prototype=Object.create(m.prototype);b.prototype.addTag=function(a){this.tags[a]=!0};b.prototype.expire=function(){this.isExpired=!0};b.prototype.getColor=function(){return this.color};b.prototype.getExpired=function(){return this.isExpired};b.prototype.getLayerIndex=function(){return this.layerIndex};b.prototype.getScene=function(){return this.scene};b.prototype.getTick=
function(){return this.tick};b.prototype.hasTag=function(a){return this.tags[a]?!0:!1};b.prototype.getEssential=function(){return this.isEssential};b.prototype.getSolid=function(){return this.isSolid};b.prototype.onCollision=function(a){this.delegate&&this.delegate.onCollision&&this.delegate.onCollision(a)};b.prototype.setColor=function(a){this.color=a};b.prototype.setEssential=function(a){this.isEssential=void 0==a||a};b.prototype.setLayerIndex=function(a){this.layerIndex=a||0};b.prototype.setScene=
function(a){this.scene=a};b.prototype.setSolid=function(a){this.isSolid=void 0==a||a};b.prototype.setVisible=function(a){this.isVisible=void 0==a||a};b.prototype.render=function(a){if(this.isVisible){if(this.color){var b=Math.floor(this.getX()),c=Math.floor(this.getY());a.fillStyle=this.color;a.fillRect(b,c,this.getWidth(),this.getHeight())}m.prototype.render.call(this,a)}};b.prototype.sync=function(){if(this.getExpired())return!0;++this.tick;return m.prototype.sync.call(this)};b.prototype.update=
function(){this.delegate&&this.delegate.update&&this.delegate.update()};return b}(),N=function(){function b(a){l.call(this);this.setText(a||"")}b.prototype=Object.create(h.prototype);b.prototype.parse=function(a){for(var b=0,c=0,d=0,h=0,f=0;f<this.text.length;++f){var g=this.text[f];" "==g?d+=4:"\n"==g?(d=0,h+=b+0):(g=document.getElementById(g+"Font"),a&&a.drawImage(g,this.getX()+d,this.getY()+h,g.width,g.height),d+=g.width+0,d>c&&(c=d),g.height>b&&(b=g.height))}this.setWidth(c);this.setHeight(h+
b)};b.prototype.render=function(a){this.parse(a)};b.prototype.setText=function(a){this.text=a;this.parse()};return b}(),C=function(){function b(a){h.call(this);this.setImageId(a)}b.prototype=Object.create(h.prototype);return b}(),O=function(){function b(){h.call(this);this.setColor("Black");this.setHeight(k.getCanvasHeight());this.increase=k.getCanvasWidth()/32}b.prototype=Object.create(h.prototype);b.prototype.sync=function(){if(this.getWidth()>k.getCanvasWidth())return!0;this.increaseWidth(this.increase);
k.paint(this);return h.prototype.sync.call(this)};return b}();window.com||(window.com={});window.com.dgsprb||(window.com.dgsprb={});window.com.dgsprb.quick={Animation:D,BaseTile:C,BaseTransition:O,CommandEnum:c,Frame:u,GameObject:h,ImageFactory:G,Point:w,Quick:k,Rect:l,Scene:L,Text:N}})();
